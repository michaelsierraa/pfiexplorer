<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Police Firearm Injury Explorer (PFIE)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <!-- Papa Parse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Flatpickr (dark theme) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="app-wrapper">

  <!-- ── HEADER ─────────────────────────────────────────────────────────── -->
  <header class="app-header">
    <div class="header-title">
      <span class="title-full">Police Firearm Injury Explorer (PFIE)</span>
      <span class="title-short">PFIE</span>
    </div>
  </header>

  <!-- ── APP BODY ───────────────────────────────────────────────────────── -->
  <div class="app-body">

    <!-- Mobile backdrop -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- ── SIDEBAR ──────────────────────────────────────────────────────── -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-inner">

        <div class="filter-section">
          <label class="filter-label">Date Range</label>
          <div class="date-row">
            <input type="text" id="dateStart" class="date-input" placeholder="Start" readonly>
            <span class="date-sep">–</span>
            <input type="text" id="dateEnd" class="date-input" placeholder="End" readonly>
          </div>
        </div>

        <div class="filter-section">
          <label class="filter-label" for="stateSelect">State</label>
          <select id="stateSelect" class="filter-select">
            <option value="National">National</option>
          </select>
        </div>

        <div class="filter-section">
          <label class="filter-label" for="agencySelect">Agency Type</label>
          <select id="agencySelect" class="filter-select">
            <option value="All">All</option>
            <option value="Local">Local</option>
            <option value="Sheriff">Sheriff</option>
            <option value="State">State</option>
            <option value="Special">Special</option>
          </select>
        </div>

        <div class="filter-section">
          <label class="filter-label" for="statusSelect">Injury Status</label>
          <select id="statusSelect" class="filter-select">
            <option value="All">All</option>
            <option value="Fatal">Fatal</option>
            <option value="Nonfatal">Nonfatal</option>
          </select>
        </div>

        <div class="filter-section">
          <label class="filter-label" for="formatSelect">Export Format</label>
          <select id="formatSelect" class="filter-select">
            <option value="CSV">CSV</option>
            <option value="JSON">JSON</option>
            <option value="TXT">TXT (tab-separated)</option>
          </select>
        </div>

        <button class="download-btn" id="downloadBtn">
          <i class="fa-solid fa-download"></i>
          Export Filtered Data
        </button>

        <div class="case-count" id="caseCount">Loading data…</div>

      </div>
    </aside>

    <!-- ── MAIN CONTENT ─────────────────────────────────────────────────── -->
    <main class="main-content">

      <!-- Tab nav -->
      <nav class="tab-nav" role="tablist">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle filters">
          <i class="fa-solid fa-filter"></i>
          <span class="toggle-label">Filters</span>
        </button>
        <div class="tab-nav-divider" aria-hidden="true"></div>
        <button class="tab-btn active" data-tab="map" role="tab" aria-selected="true">Plots</button>
        <button class="tab-btn" data-tab="data" role="tab" aria-selected="false">Data</button>
        <button class="tab-btn" data-tab="about" role="tab" aria-selected="false">About PFIE</button>
      </nav>

      <!-- ── MAP TAB ──────────────────────────────────────────────────── -->
      <div class="tab-panel active" id="tab-map" role="tabpanel">

        <!-- Toolbar: sliders + buttons in a compact horizontal strip -->
        <div class="map-toolbar">
          <div class="toolbar-sliders">
            <div class="toolbar-slider">
              <label class="slider-label" for="markerSize">Marker Size</label>
              <input type="range" id="markerSize" min="1" max="10" value="2" step="1">
              <span class="slider-val" id="markerSizeVal">2</span>
            </div>
            <div class="toolbar-slider">
              <label class="slider-label" for="jitterScale">Map Jitter</label>
              <input type="range" id="jitterScale" min="0" max="10" value="3" step="0.5">
              <span class="slider-val" id="jitterScaleVal">3</span>
            </div>
          </div>
          <div class="toolbar-divider"></div>
          <div class="map-btn-row">
            <button class="map-btn" id="toggleClustering">
              <i class="fa-solid fa-circle-nodes"></i>
              Enable Clustering
            </button>
            <button class="map-btn" id="fitAll">
              <i class="fa-solid fa-expand"></i>
              Fit to Cases
            </button>
            <button class="map-btn" id="freezeMap">
              <i class="fa-solid fa-snowflake"></i>
              Freeze Map
            </button>
            <button class="map-btn" id="toggleLegend">
              <i class="fa-solid fa-eye-slash"></i>
              Hide Legend
            </button>
          </div>
        </div>

        <!-- 3-cell grid: map spans full left height, charts stack on right -->
        <div class="map-grid">

          <!-- LEFT: map (spans both rows) -->
          <div class="map-cell map-cell--map">
            <div id="pfiemap"></div>
          </div>

          <!-- TOP-RIGHT: trend chart -->
          <div class="map-cell trend-cell">
            <div id="trendsMain" class="plot-area"></div>
          </div>

          <!-- BOTTOM-RIGHT: bar chart -->
          <div class="map-cell bar-cell">
            <div id="barChart" class="plot-area"></div>
          </div>

        </div>

      </div><!-- end map tab -->

      <!-- ── DATA TAB ─────────────────────────────────────────────────── -->
      <div class="tab-panel" id="tab-data" role="tabpanel">
        <div class="tab-inner">
          <div class="card table-card">
            <div class="table-caption" id="tableCaption"></div>
            <div class="table-scroll">
              <table id="pfieTable" class="display cell-border stripe" style="width:100%"></table>
            </div>
          </div>
        </div>
      </div>

      <!-- ── ABOUT TAB ─────────────────────────────────────────────────── -->
      <div class="tab-panel" id="tab-about" role="tabpanel">
        <div class="tab-inner">
          <div class="card about-card">
            <h2>About the Police Firearm Injury Explorer (PFIE)</h2>
            <p>The Police Firearm Injury Explorer builds on data made available by the
            <a href="https://www.gunviolencearchive.org/about" target="_blank" rel="noopener">Gun Violence Archive (GVA)</a>.
            GVA is a non-partisan, non-profit organization that compiles information on incidents of gun violence from
            over 7,500 law enforcement, media, government, and commercial sources daily in an effort to provide
            near-real-time data about the results of gun violence.</p>

            <h3>Frequently Asked Questions</h3>

            <h4>What cases are included in the PFIE dataset?</h4>
            <p>PFIE was constructed using GVA data which recorded law enforcement officers who were victims
            of any type of firearm violence (e.g., firearm homicide, assault, accident, suicide).</p>

            <p><strong>Cases included:</strong></p>
            <ul>
              <li>Victim is a sworn, active-duty law enforcement officer.</li>
              <li>Shot fatally or nonfatally with a firearm by a suspect.</li>
              <li>Shot somewhere on their body or on-person equipment (e.g., radio, ballistic helmet).</li>
            </ul>

            <p><strong>Cases excluded:</strong></p>
            <ul>
              <li>Victim was a retired or off-duty law enforcement officer.</li>
              <li>Victim was a corrections or federal law enforcement officer (FBI, ATF, Marshals, etc.).</li>
              <li>Victim was shot by another law enforcement officer (blue-on-blue shootings).</li>
              <li>Victim shot themselves accidentally or intentionally (training accident, suicide, etc.).</li>
            </ul>

            <h4>Who created PFIE?</h4>
            <p>
              <a href="https://www.sierraarevalo.com" target="_blank" rel="noopener">Michael Sierra-Arévalo</a>
              (University of Texas) and
              <a href="https://jnix.netlify.app/about" target="_blank" rel="noopener">Justin Nix</a>
              (University of Nebraska–Omaha) designed the coding scheme and led data cleaning and coding.
            </p>
            <p>Coding was supported by Aidan Bach, Tommy Flaherty, Ciara Garcia,
            Kateryna Kaplun, Philip Phu Pham, and Jamie Villarreal.</p>
            <p>The PFIE application was written by Michael Sierra-Arévalo.</p>

            <h4>Preferred Citation</h4>
            <p>Sierra-Arévalo, M., Nix, J., Bach, A., Flaherty, T., Garcia, C., Kaplun, K., Pham, P. P., &amp;
            Villarreal, J. (2024). <em>The Police Firearm Injury Explorer.</em>
            Retrieved from <a href="https://michaelsierraa.shinyapps.io/pfie/" target="_blank" rel="noopener">https://michaelsierraa.shinyapps.io/pfie/</a></p>
          </div>
        </div>
      </div>

    </main>
  </div><!-- end app-body -->

  <!-- ── LOADING OVERLAY ──────────────────────────────────────────────────── -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
      <i class="fa-solid fa-circle-notch fa-spin"></i>
      <p>Loading PFIE data…</p>
    </div>
  </div>

</div><!-- end app-wrapper -->

<script src="js/app.js"></script>
</body>
</html>
